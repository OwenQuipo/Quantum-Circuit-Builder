<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Qubit Visualizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="/src/styles/index.css" />

  <!-- MathJax for LaTeX rendering -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>

<body data-theme="dark">
  <div id="qubit-visualizer">
    <!-- =========================
         Topbar (always visible)
         ========================= -->
    <header id="topbar" role="banner">
      <div id="title" aria-label="App title">Qubit Visualizer</div>

      <button id="beginnerToggle" class="icon-btn" title="Toggle beginner mode" aria-label="Toggle beginner mode">
        <span class="ico">◎</span>
        <span id="beginnerToggleLabel">Beginner</span>
      </button>

      <button id="themeToggle" class="icon-btn" title="Toggle pixel dark/light mode" aria-label="Toggle theme">
        <span class="ico">PX</span>
        <span id="themeToggleLabel">Dark</span>
      </button>

      <div class="spacer"></div>

      <!-- step controls compact (always visible) -->
      <div id="stepControls" class="step-controls" aria-label="Step controls">
        <button id="prevStep" class="icon-btn" title="Prev step (ArrowLeft)" aria-label="Prev step">
          <span class="ico">←</span>
        </button>

        <button id="playPause" class="icon-btn" title="Play/Pause (Space)" aria-label="Play/Pause">
          <span class="ico" id="playIcon">▶</span>
        </button>

        <button id="nextStep" class="icon-btn" title="Next step (ArrowRight)" aria-label="Next step">
          <span class="ico">→</span>
        </button>

        <div id="stepCounter" class="step-counter" aria-label="Step counter">
          Step <span id="activeStepLabel">–</span>/<span id="stepCountLabel">12</span>
        </div>
      </div>

      <div class="spacer"></div>

      <!-- Qubit controls (always visible) -->
      <div class="qubit-controls" aria-label="Qubit controls">
        <button id="removeQubitTop" class="icon-btn" title="Remove qubit" aria-label="Remove qubit">
          <span class="ico">−</span>
        </button>
        <div id="qubitCountLabel" class="step-counter" aria-label="Qubit count">Qubits <span id="qubitCountNum">1</span>/10</div>
        <button id="addQubitTop" class="icon-btn" title="Add qubit" aria-label="Add qubit">
          <span class="ico">＋</span>
        </button>
      </div>

      <button id="resetState" class="icon-btn" title="Reset visualization state (R)" aria-label="Reset visualization state">
        <span class="ico">⟲</span>
      </button>

      <!-- kebab menu -->
      <div id="moreMenu" class="menu">
        <button id="moreMenuBtn" class="icon-btn" aria-haspopup="menu" aria-expanded="false" title="More">
          <span class="ico">⋮</span>
        </button>

        <div id="moreMenuPopover" class="menu-popover" role="menu" aria-label="More menu">
          <button class="menu-item danger" id="menuClearCircuit" role="menuitem">Clear circuit…</button>

          <div class="menu-sep"></div>

          <div class="menu-group" role="none">
            <div class="menu-label">Bell states</div>
            <button class="menu-item" id="menuBellPhiPlus" role="menuitem">Bell &Phi;+</button>
            <button class="menu-item" id="menuBellPhiMinus" role="menuitem">Bell &Phi;-</button>
            <button class="menu-item" id="menuBellPsiPlus" role="menuitem">Bell &Psi;+</button>
            <button class="menu-item" id="menuBellPsiMinus" role="menuitem">Bell &Psi;-</button>
          </div>

          <div class="menu-sep"></div>

          <div class="menu-group" role="none">
            <div class="menu-label">Export…</div>
            <button class="menu-item" id="menuExportJson" role="menuitem">Export JSON</button>
            <button class="menu-item" id="menuExportPng" role="menuitem">Export PNG</button>
          </div>

          <div class="menu-sep"></div>

          <div class="menu-group" role="none">
            <div class="menu-label">Settings…</div>
            <button class="menu-item" id="menuTheme" role="menuitem">Toggle theme</button>
            <button class="menu-item" id="menuShortcuts" role="menuitem">Shortcuts</button>
            <button class="menu-item" id="menuSimulation" role="menuitem">Simulation</button>
          </div>
        </div>
      </div>
    </header>

    <!-- =========================
         Main split view (always visible)
         ========================= -->
    <main id="main" role="main">
      <!-- Bloch pane -->
      <section id="blochPane" class="pane" aria-label="Bloch pane">
        <section id="beginnerPanel" class="beginner-panel" aria-label="Beginner panel">
          <div class="beginner-header">
            <div>
              <div class="beginner-title">First Qubit</div>
              <div class="beginner-sub">Watch how behavior changes before learning symbols.</div>
            </div>
            <div class="beginner-actions">
              <button id="beginnerShowBloch" class="micro-btn" type="button">Show Bloch</button>
              <button id="beginnerShowTimeline" class="micro-btn" type="button">Show Timeline</button>
            </div>
          </div>

          <div class="beginner-grid">
            <div class="beginner-card state-card">
              <div class="card-title">State Now</div>
              <div id="beginnerStateText" class="card-body">If you measure now, 0 happens 100% of the time.</div>
              <div id="beginnerDelta" class="card-note">No changes yet.</div>
              <div id="beginnerEntangledNote" class="card-note hidden">This qubit is entangled. It cannot be described alone.</div>
            </div>

            <div class="beginner-card action-card">
              <div class="card-title">Try An Action</div>
              <div class="beginner-action-grid">
                <button id="beginnerActionUndecided" class="micro-btn" type="button">Make It Undecided</button>
                <button id="beginnerActionFlip" class="micro-btn" type="button">Flip It</button>
                <button id="beginnerActionTwist" class="micro-btn" type="button">Add A Twist</button>
                <button id="beginnerActionMeasure" class="micro-btn danger" type="button">Measure Now</button>
                <button id="beginnerActionReset" class="micro-btn" type="button">Reset</button>
              </div>
            </div>

            <div class="beginner-card" id="probabilityPanel">
              <div class="card-title">Probabilities</div>
              <div id="probHistogramBeginner" class="mini-histogram" aria-label="Probability histogram"></div>
              <div id="probNoteBeginner" class="popover-note">Probabilities show what a measurement would produce.</div>
            </div>

            <div class="beginner-card hidden" id="jointProbPanel">
              <div class="card-title">Joint Probabilities</div>
              <div id="jointProbGrid" class="joint-prob-grid"></div>
              <div id="jointProbNote" class="popover-note">When entangled, only the pair is fully knowable.</div>
              <div id="jointProbCondition" class="card-note"></div>
            </div>

            <div class="beginner-card" id="interferencePanel">
              <div class="card-title">Interference View</div>
              <div id="interferenceGrid" class="interference-grid"></div>
              <div class="popover-note">Phase twists change how possibilities combine.</div>
            </div>

            <div class="beginner-card">
              <div class="card-title">Timeline</div>
              <div class="timeline-row">
                <input id="beginnerTimeline" type="range" min="0" max="12" step="1" value="0" />
                <div id="beginnerTimelineLabel" class="timeline-label">Start</div>
              </div>
              <div class="timeline-note">Drag to scrub the story of changes. Noise overlay is visual-only.</div>
            </div>

            <div class="beginner-card">
              <div class="card-title">Presets</div>
              <div class="preset-grid">
                <button class="micro-btn" data-preset="superposition" type="button">Superposition</button>
                <button class="micro-btn" data-preset="interference" type="button">Interference</button>
                <button class="micro-btn" data-preset="bell" type="button">Bell Pair</button>
                <button class="micro-btn" data-preset="collapse" type="button">Measurement Collapse</button>
              </div>
              <div class="timeline-note">Each preset auto-builds a short story.</div>
            </div>

            <div class="beginner-card">
              <div class="card-title">Measurement Seed</div>
              <div class="seed-row">
                <input id="beginnerSeed" type="number" inputmode="numeric" placeholder="Seed" />
                <button id="beginnerSeedApply" class="micro-btn" type="button">Set</button>
                <button id="beginnerSeedReroll" class="micro-btn" type="button">Reroll</button>
              </div>
              <div class="timeline-note">Same seed = same random outcomes.</div>
            </div>
          </div>
        </section>

        <div id="blochCanvas" aria-label="Bloch canvas region">
          <div id="bloch-grid"></div>
          <div id="blochRevealOverlay" class="bloch-reveal">Probabilities first. Scrub the timeline to reveal the Bloch view.</div>
          <div id="quietHud">
            <button id="quietPrompt" type="button">change state</button>
            <div id="quietActionWheel" role="menu" aria-label="Qubit actions">
              <div class="quiet-tabs" role="tablist" aria-label="Action tabs">
                <button class="quiet-tab is-active" type="button" data-tab="core" role="tab" aria-selected="true">core</button>
                <button class="quiet-tab" type="button" data-tab="fun" role="tab" aria-selected="false">neat things</button>
              </div>
              <div class="quiet-panel" data-tab="core">
                <button class="quiet-action" type="button" data-action="undecided" data-desc="<strong>Make it undecided.</strong><br>Turns a definite answer into a balanced mix of 0 and 1.<br>\(H\lvert 0 \rangle = \tfrac{\lvert 0 \rangle + \lvert 1 \rangle}{\sqrt{2}}\)<br>This is the gateway to everything quantum: interference, entanglement, and weirdness.">make undecided</button>
                <button class="quiet-action" type="button" data-action="flip" data-desc="<strong>Flip the answer.</strong><br>Turns a definite 0 into 1, and 1 into 0.<br>\(X\lvert 0 \rangle = \lvert 1 \rangle\)<br>If the qubit was undecided, it swaps the chances instead of choosing.">flip</button>
                <button class="quiet-action" type="button" data-action="measure" data-desc="<strong>Measure.</strong><br>Collapse to a single outcome right now.">measure</button>
                <button class="quiet-action" type="button" data-action="detail" data-desc="<strong>Show circuit.</strong><br>Reveal the circuit timeline.">show circuit</button>
                <button class="quiet-action" type="button" data-action="reset" data-desc="<strong>Reset.</strong><br>Return to the initial step.">reset</button>
              </div>
              <div class="quiet-panel" data-tab="fun">
                <button class="quiet-action" type="button" data-action="entangle-demo" data-desc="<strong>Entanglement demo.</strong><br>Watch two qubits share a single, linked state.">entangle</button>
                <div id="funEntangleDesc" class="quiet-fun-desc">
                  \( \lvert \Phi^+ \rangle = \tfrac{\lvert 00 \rangle + \lvert 11 \rangle}{\sqrt{2}} \)
                  <br />
                  \( \lvert \Phi^- \rangle = \tfrac{\lvert 00 \rangle - \lvert 11 \rangle}{\sqrt{2}} \)
                  <br />
                  \( \lvert \Psi^+ \rangle = \tfrac{\lvert 01 \rangle + \lvert 10 \rangle}{\sqrt{2}} \)
                  <br />
                  \( \lvert \Psi^- \rangle = \tfrac{\lvert 01 \rangle - \lvert 10 \rangle}{\sqrt{2}} \)
                  <br />
                  Entanglement links two qubits into a single shared state. Measuring one instantly fixes the other’s outcome,
                  not by sending a signal, but because the pair is described by one joint wavefunction. The results are correlated
                  in ways no classical system can reproduce.
                </div>
              </div>
            </div>
            <div id="quietTooltip" aria-hidden="true"></div>
            <div id="quietStateLine" aria-live="polite"></div>
            <div id="quietSecondaryLine" aria-live="polite">
              <span id="quietSecondaryText"></span>
              <span id="quietSecondaryValue" class="quiet-value"></span>
            </div>
            <button id="quietHideCircuit" type="button">hide circuit</button>
          </div>
          <div id="entanglementBadge">State stored in correlations</div>
          <div id="correlationsPanel" class="micro-panel" aria-label="Correlations panel">
            <div class="micro-row">
              <div class="micro-title">Correlations</div>
              <button id="inspectRho" class="micro-icon" title="Inspect density matrix">⧉</button>
            </div>
            <div class="corr-pair">
              <span class="corr-label" id="corrPairLabel">Pair</span>
              <select id="corrPairSelect" class="corr-select" aria-label="Select qubit pair"></select>
            </div>
            <div class="corr-hint">Choose a pair to view ⟨X⊗X⟩, ⟨Y⊗Y⟩, ⟨Z⊗Z⟩.</div>
            <div class="corr-row"><span>&lt;X⊗X&gt;</span><div class="corr-bar"><div id="corrXX" class="corr-fill"></div></div><span id="corrXXVal" class="corr-val">0</span></div>
            <div class="corr-row"><span>&lt;Y⊗Y&gt;</span><div class="corr-bar"><div id="corrYY" class="corr-fill"></div></div><span id="corrYYVal" class="corr-val">0</span></div>
            <div class="corr-row"><span>&lt;Z⊗Z&gt;</span><div class="corr-bar"><div id="corrZZ" class="corr-fill"></div></div><span id="corrZZVal" class="corr-val">0</span></div>
            <div class="corr-actions">
              <button id="measureQ0" class="micro-btn" type="button">Measure q0</button>
              <button id="measureQ1" class="micro-btn" type="button">Measure q1</button>
            </div>
          </div>

          <div id="inspectPopover" class="popover inspect-popover" aria-label="Density matrix heatmap">
            <div class="inspect-header">
              <div>ρ (2-qubit)</div>
              <button id="closeInspect" class="micro-icon" title="Close">×</button>
            </div>
            <div id="inspectGrid" class="inspect-grid"></div>
          </div>
        </div>

        <!-- micro overlay (bottom-left) -->
        <div id="blochOverlay" class="micro-overlay settings-panel" aria-label="Settings overlay">
          <div id="settingsHeader" class="settings-header" title="Drag to move">
            <span class="settings-title">Settings</span>
            <div class="settings-actions">
              <button id="settingsCollapse" class="micro-icon" title="Collapse/expand">▾</button>
            </div>
          </div>
          <div id="settingsBody" class="settings-body">
            <label class="micro-toggle" title="Toggle trajectory trail">
              <input id="toggleTrajectory" type="checkbox" checked />
              <span class="micro-pill">Trail</span>
            </label>

            <label class="micro-toggle" title="Toggle measurement flip animation">
              <input id="toggleMeasurementAnim" type="checkbox" checked />
              <span class="micro-pill">Flip anim</span>
            </label>

              <label class="micro-slider" title="Adjust Bloch tile size">
                <span class="micro-pill">Tile size</span>
              <input id="blochTileSize" type="range" min="120" max="520" step="10" value="320" />
              <span id="blochTileSizeVal" class="micro-pill size-val">320px</span>
              </label>

              <label class="micro-slider" title="Adjust noise intensity">
                <span class="micro-pill">Noise</span>
              <input id="noiseLevel" type="range" min="0" max="100" step="1" value="45" />
              <span id="noiseLevelVal" class="micro-pill size-val">45%</span>
              </label>

            <button id="openProbPopover" class="micro-btn" title="Probabilities">
              Probs
            </button>

            <button id="openBackendDrawer" class="micro-btn" title="Backend math">
              Math
            </button>
          </div>
        </div>

        <!-- Prob popover (anchored near overlay) -->
        <div id="probPopover" class="popover" aria-label="Probabilities popover">
          <div id="probHistogram" class="mini-histogram" aria-label="Probability histogram"></div>
          <div id="probNote" class="popover-note">Probabilities reflect measurement of the full register.</div>
        </div>

        <div id="measurementAnimOverlay" class="coin-overlay" aria-label="Measurement animation">
          <div class="coin-panel">
            <div class="coin-panel-head">
              <div class="coin-panel-title">Measurement flip</div>
              <div id="coinOutcomeLabel" class="coin-outcome">Ready</div>
            </div>
            <div id="coinOdds" class="coin-odds">Odds: –</div>
            <div id="coinMount" class="coin-mount" aria-hidden="true"></div>
          </div>
        </div>
      </section>

      <!-- primary splitter -->
      <div id="primarySplitter" class="splitter" aria-label="Resize panes" title="Drag to resize"></div>

      <!-- Circuit pane -->
      <section id="circuitPane" class="pane" aria-label="Circuit pane">
        <!-- Circuit canvas area (existing IDs preserved) -->
        <div id="circuitCanvas">
          <div id="circuit-grid">
            <div id="circuit-canvas"></div>
          </div>
        </div>
      </section>
    </main>

    <!-- =========================
         Gate library (ALWAYS visible)
         ========================= -->
    <div id="gateLibrary" class="floating-panel always-open" aria-label="Gate library">
      <div class="floating-header">
        <button id="gateLibToggle" class="icon-btn" type="button" title="Minimize/Maximize (L)">
        <span class="ico">▾</span>
        </button>

        <div class="floating-title">Gate Library</div>
        <div class="floating-hint">Hover a gate to preview its matrix</div>
      </div>

      <!-- hover math preview -->
      <div id="gateHoverMath" class="gate-hover-math" aria-label="Gate matrix preview"></div>

      <!-- Existing palette renderer expects #gatePaletteRow -->
      <div id="gatePaletteRow" class="gate-library-grid"></div>
    </div>

    <!-- =========================
         Backend drawer (bottom, on demand)
         ========================= -->
    <div id="backendDrawer" class="drawer" aria-hidden="true">
      <div id="backendHeader" class="drawer-header">
        <div class="drawer-left">Unitary / State Update</div>

        <div class="drawer-right">
          <label class="drawer-toggle" title="Simplify">
            <input id="toggleSimplify" type="checkbox" checked />
            <span>Simplify</span>
          </label>

          <label class="drawer-toggle" title="Show matrix">
            <input id="toggleShowMatrix" type="checkbox" />
            <span>Show matrix</span>
          </label>

          <button id="copyLatex" class="icon-btn" title="Copy LaTeX" aria-label="Copy LaTeX">
            <span class="ico">⧉</span>
          </button>

          <button id="closeBackendDrawer" class="icon-btn" title="Close (Esc)" aria-label="Close drawer">
            <span class="ico">×</span>
          </button>
        </div>
      </div>

      <div id="unitaryMath" class="mathjax-panel">
        <div class="math-col">
          <div class="math-block">
            <div class="math-label">Gate</div>
            <div id="currentGateLatex" class="math-content"></div>
          </div>

          <div class="math-block">
            <div class="math-label">Update</div>
            <div id="stateUpdateLatex" class="math-content"></div>
          </div>

          <div class="math-block" id="matrixBlock">
            <div class="math-label">Matrix</div>
            <div id="optionalMatrixLatex" class="math-content"></div>
          </div>
        </div>

        <div class="math-col">
          <div class="math-block">
            <div class="math-label">Bloch mapping</div>
            <div id="blochUpdateLatex" class="math-content"></div>
          </div>

          <div class="math-block">
            <div class="math-label">Notes</div>
            <div id="notesLatex" class="math-content"></div>
          </div>
        </div>
      </div>

      <div id="drawerHandle" class="drawer-handle" title="Drag down to close"></div>
    </div>

    <!-- lightweight backdrop for overlays (NOT used for gate library anymore) -->
    <div id="overlayBackdrop" class="backdrop" aria-hidden="true"></div>
    <div id="toast" class="toast"></div>
  </div>

  <script type="module" src="./main.js"></script>
</body>
</html>
